input {
  # Receive from Beats (Filebeat, Winlogbeat, Auditbeat)
  beats {
    port => 5045
  }

  # Read Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    type => "nginx-access"
  }

  # Read Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    type => "nginx-error"
  }

  # Listen for syslog
  syslog {
    port => 5000
    type => "syslog"
  }

  # Generate test data
  generator {
    message => "Test message from Logstash generator"
    count => 100
  }
}

filter {
  # Parse Nginx access logs
  if [type] == "nginx-access" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    mutate {
      convert => { "bytes" => "integer" }
      convert => { "response" => "integer" }
    }
  }

  # Parse Nginx error logs - use simple pattern (don't use %{NGINX_ERROR_LOG})
  if [type] == "nginx-error" {
    grok {
      match => { "message" => "%{DATA:timestamp} \[%{DATA:severity}\] %{GREEDYDATA:message}" }
      overwrite => ["message"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["https://elasticsearch:9200"]
    user => "elastic"
    password => "elastic"
    cacert => "/usr/share/logstash/config/certs/ca/ca.crt"
    ssl => true 
    index => "logstash-%{[type]}-%{+YYYY.MM.dd}"
  }

  stdout { 
    codec => rubydebug 
  }
}
